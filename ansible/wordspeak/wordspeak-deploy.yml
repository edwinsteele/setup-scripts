# -*- mode: ruby -*-
# vi: set ft=ruby :
#
# system packages to support the build and deployment of the wordspeak site
# Make sure python27.yml is run before this...
- hosts: vagrant
  sudo: yes
  sudo_user: root
  gather_facts: yes

  tasks:
    # Need enchant 1.6 due to http://bugzilla.abisource.com/show_bug.cgi?id=12350 which is in 1.5 (RHEL6 default)
    # Use flexbox repo: http://sourceforge.net/projects/flexbox/files/
    # TODO Load key with rpm_key and enable gpg in repo conf
    - name: Install flexbox repo rpm
      yum: name=http://aarnet.dl.sourceforge.net/project/flexbox/flexbox-release-1-1.noarch.rpm
            state=present

    - name: Install xz for subsequent Linkchecker setup
      yum: name=xz state=present

    - name: Install enchant for spell checking
      yum: name=enchant state=present
    - name: Install enchant-aspell for aspell compatibility
      yum: name=enchant-aspell state=present
    - name: Install GB English aspell dictionary
      yum: name=aspell-en state=present
    - name: Install libxslt-devel (pulls in libxml2-devel and libxslt)
      yum: name=libxslt-devel state=present

    - name: Setup staging.wordspeak.org parent directory
      file: path=/home/esteele/Sites/staging.wordspeak.org state=directory
             mode=0711 owner=esteele group=esteele

    - name: Setup www.wordspeak.org parent directory
      file: path=/home/esteele/Sites/www.wordspeak.org state=directory
             mode=0711 owner=esteele group=esteele

    #- name: Install Nikola with deps into wordspeak venv
    #  pip: name=nikola virtualenv_command=virtualenv-2.7 version=5.5.1
    #        virtualenv=/home/esteele/.virtualenvs/wordspeak

    - name: Create Nikola Cache directory
      file: path=/home/esteele/tmp/nikola_wordspeak_cache state=directory
             mode=0755 owner=esteele group=esteele

    - name: Create Nikola Output directory
      file: path=/home/esteele/tmp/nikola_wordspeak_output state=directory
             mode=0755 owner=esteele group=esteele

    # Just install something so that the venv gets created. Pick lxml also because it regularly has problems building as a part of a big pip install, quite possibly due to memory starvation on the vm
    - name: Install lxml for nikola
      sudo: True
      sudo_user: esteele
      pip: name=lxml virtualenv=/home/esteele/.virtualenvs/wordspeak version=3.2.3

    # Git setup can't be done via ansible because of the private keys
    #- name: Checkout wordspeak repo
    #  git: repo=ssh://git@github.com/edwinsteele/wordspeak.org.git
    #        dest=/home/esteele/Code
    #- name: Checkout d3-projects submodule
    #  command: git submodule update --init chdir=/home/esteele/Code/wordspeak.org
    #            creates=/home/esteele/Code/wordspeak.org/files/d3-projects/.git
