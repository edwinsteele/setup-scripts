---
- hosts: webservers
  sudo: yes
  gather_facts: no
  vars_files:
    - vars/defaults.yml

  tasks:

    # Configure users and groups
    - name: create admin group
      action: group name=admin gid=1002 system=no

    - name: create esteele group
      action: group name=esteele gid=1003 system=no

    - name: create user(s)
      action: user name=esteele group=esteele groups=admin shell=/bin/bash uid=1003

    - name: setup authorised key(s)
      action: authorized_key user=esteele key='$FILE(/Users/esteele/.ssh/id_rsa.pub)'

    # Access, security and perms
    - name: write the sudoers file
      template: src=templates/custom_sudo.j2 dest=/etc/sudoers.d/wordspeak
                 owner=root group=root mode=0400
    - name: write the sshd_config file
      template: src=templates/sshd_config.j2 dest=/etc/ssh/sshd_config
              owner=root group=root mode=0600
      notify:
        - Reload sshd

    - name: Set timezone as Sydney
      file: src=/usr/share/zoneinfo/Australia/Sydney dest=/etc/localtime
             state=link owner=root group=root

    # ntp
    - yum: name=ntp state=latest
    - name: Ensure NTP is up and running
      action: service name=ntpd state=started

    # nginx
    - yum: name=nginx state=latest
    - name: Setup base nginx config
      template: src=templates/nginx.j2 dest=/etc/nginx/nginx.conf
                 owner=root group=root mode=0644
    - name: Setup nginx default site config
      template: src=templates/nginx_confd_default.j2
                 dest=/etc/nginx/conf.d/default.conf
                 owner=root group=root mode=0644
    - name: Setup nginx wordspeak staging config
      template: src=templates/nginx_confd_staging_wordspeak_org.j2
                 dest=/etc/nginx/conf.d/staging_wordspeak_org.conf
                 owner=root group=root mode=0644

    # Python stuff
    - name: Install pip for system python
      yum: name=python-pip state=latest

    - name: Install virtualenv as system site-package
      pip: name=virtualenv

    - yum: name=mosh state=latest
    - yum: name=tmux state=latest
    - yum: name=git state=latest
    - yum: name=enchant state=latest
    - yum: name=enchant-aspell state=latest
    - yum: name=aspell-en state=latest



  handlers:
    - name: Reload sshd
      action: service name=sshd state=reloaded
