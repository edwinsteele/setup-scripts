---
- name: create group - esteele
  action: group name=esteele gid=1003 system=no

- name: create user esteele
  action: user name=esteele group=esteele groups=wheel,wsrc

- name: set login class esteele
  user: login_class=staff name=esteele

# Also takes care of .ssh directory setup
- name: setup authorised key esteele
  action: authorized_key user=esteele
          key="{{ lookup('file', '/Users/esteele/.ssh/id_rsa.pub') }}"

# Have this run after there's a task that runs as esteele so the
#  skeleton .profile is in place
# OpenBSD data segment limits are too small to allow building of python lxml
- name: Increase data segment ulimit
  lineinfile: dest=/home/esteele/.profile line="ulimit -Sd 1000000"
              state=present owner=esteele group=esteele

- name: Provide sensible defaults for cvs (personal .cvsrc)
  file: src=cvsrc dest=/home/esteele/.cvsrc owner=esteele group=esteele

- name: Setup git variables for esteele
  become: True
  become_user: esteele
  become_method: doas
  ini_file: dest=/home/esteele/.gitconfig section={{ item.section }}
             option={{ item.option }} value="{{ item.value }}"
  with_items:
    - { section: user, option: email, value: edwin@wordspeak.org }
    - { section: user, option: name, value: Edwin Steele }
    - { section: push, option: default, value: current }

- name: Add Github's ssh key
  lineinfile: mode="0644" owner="esteele" group="esteele"
              state="present" dest="/home/esteele/.ssh/known_hosts"
              create="yes"
              line='github.com,192.30.252.129 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=='

- name: Setup private_profile placeholder
  lineinfile: dest=/home/esteele/.profile_private mode=0600 create=yes
        owner=esteele group=esteele line="" state=present

- name: Setup ~esteele/Code
  file: path=/home/esteele/Code state=directory mode=0755
        owner=esteele group=esteele

# doas preserves USER, which is different to sudo, however by
#  specifying them as environment variables we can proceed.
# USER is required for git
#
# Check dotfiles out now, but only link them up in the role where
#  they're actually used. Always use HEAD (hence skip_ansible_lint)
#
# Ignore errors so that we can have local uncommitted mods and still run
#  the playbook
- name: Checkout dotfiles repo
  git: repo=https://github.com/edwinsteele/dotfiles.git
       dest=/home/esteele/Code/dotfiles
  ignore_errors: yes
  become: True
  become_method: doas
  become_user: esteele
  environment:
    USER: esteele
  tags:
    - skip_ansible_lint

